<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zap FÃ¡cil - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .card { border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .status-badge { font-weight: bold; padding: 5px 10px; border-radius: 20px; }
        .bg-connected { background-color: #d1e7dd; color: #0f5132; }
        .bg-disconnected { background-color: #f8d7da; color: #842029; }
        #qrcode img { margin: 0 auto; }
    </style>
</head>
<body class="py-5">

<div class="container">
    <div class="text-center mb-5">
        <h1 class="fw-bold text-success">Zap FÃ¡cil ðŸš€</h1>
        <p class="text-muted">Gerenciador de MÃºltiplas SessÃµes</p>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">ðŸ”Œ Gerenciar ConexÃ£o</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">ID da SessÃ£o (Cliente)</label>
                        <input type="text" id="sessionId" class="form-control" placeholder="Ex: cliente_vip_01" value="teste_01">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button onclick="iniciarSessao()" class="btn btn-primary">Gerar QR Code / Conectar</button>
                        <button onclick="verificarStatus()" class="btn btn-outline-secondary">Verificar Status</button>
                        <button onclick="desconectar()" class="btn btn-danger">Desconectar</button>
                    </div>

                    <div class="mt-4 text-center">
                        <p>Status: <span id="statusText" class="status-badge bg-disconnected">Desconectado</span></p>
                        <div id="qrcode" class="mt-3 d-flex justify-content-center"></div>
                        <div id="loading" class="spinner-border text-primary d-none" role="status"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">ðŸ“¨ Teste de Envio</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">NÃºmero (com DDD)</label>
                        <input type="text" id="targetNumber" class="form-control" placeholder="5511999999999">
                        <small class="text-muted">Apenas nÃºmeros, com 55 na frente.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mensagem</label>
                        <textarea id="messageText" class="form-control" rows="3">OlÃ¡! Teste da API Zap FÃ¡cil.</textarea>
                    </div>
                    <div class="d-grid">
                        <button onclick="enviarMensagem()" class="btn btn-success">Enviar Mensagem</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let qrcodeObj = null;

    async function iniciarSessao() {
        const sessionId = document.getElementById('sessionId').value;
        if(!sessionId) return alert('Digite um ID para a sessÃ£o');

        mostrarLoading(true);
        limparQR();

        try {
            const res = await fetch('/session/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sessionId })
            });
            const data = await res.json();
            
            atualizarInterface(data);
            
            // Se estiver aguardando QR Code, comeÃ§a a monitorar
            if (data.status === 'qrcode' || data.status === 'initializing') {
                monitorarStatus(sessionId);
            }

        } catch (error) {
            alert('Erro ao conectar: ' + error);
        } finally {
            mostrarLoading(false);
        }
    }

    async function verificarStatus() {
        const sessionId = document.getElementById('sessionId').value;
        const res = await fetch(`/session/status?sessionId=${sessionId}`);
        const data = await res.json();
        atualizarInterface(data);
    }

    async function desconectar() {
        const sessionId = document.getElementById('sessionId').value;
        if(!confirm('Tem certeza? Isso irÃ¡ desconectar o WhatsApp.')) return;
        
        await fetch('/session/logout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sessionId })
        });
        alert('SessÃ£o desconectada.');
        limparQR();
        document.getElementById('statusText').className = 'status-badge bg-disconnected';
        document.getElementById('statusText').innerText = 'Desconectado';
    }

    async function enviarMensagem() {
        const sessionId = document.getElementById('sessionId').value;
        const number = document.getElementById('targetNumber').value;
        const message = document.getElementById('messageText').value;

        if(!sessionId || !number || !message) return alert('Preencha todos os campos');

        try {
            const res = await fetch('/message/text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sessionId, number, message })
            });
            const data = await res.json();
            if(data.success) alert('Mensagem enviada com sucesso!');
            else alert('Erro: ' + JSON.stringify(data));
        } catch (e) {
            alert('Erro na requisiÃ§Ã£o');
        }
    }

    // FunÃ§Ãµes Auxiliares
    function atualizarInterface(data) {
        const statusEl = document.getElementById('statusText');
        
        if (data.status === 'connected') {
            statusEl.innerText = 'CONECTADO âœ…';
            statusEl.className = 'status-badge bg-connected';
            limparQR();
        } else if (data.status === 'qrcode' && data.qrCode) {
            statusEl.innerText = 'Aguardando Leitura...';
            statusEl.className = 'status-badge bg-warning text-dark';
            gerarQRCodeVisual(data.qrCode);
        } else {
            statusEl.innerText = data.status;
            statusEl.className = 'status-badge bg-secondary text-white';
        }
    }

    function gerarQRCodeVisual(qrString) {
        const container = document.getElementById('qrcode');
        container.innerHTML = ''; // Limpa anterior
        qrcodeObj = new QRCode(container, {
            text: qrString,
            width: 256,
            height: 256
        });
    }

    function limparQR() {
        document.getElementById('qrcode').innerHTML = '';
    }

    function mostrarLoading(show) {
        const el = document.getElementById('loading');
        if(show) el.classList.remove('d-none');
        else el.classList.add('d-none');
    }

    // Loop simples para verificar se conectou
    function monitorarStatus(sessionId) {
        let tentativas = 0;
        const intervalo = setInterval(async () => {
            const res = await fetch(`/session/status?sessionId=${sessionId}`);
            const data = await res.json();
            
            if (data.status === 'connected') {
                atualizarInterface(data);
                clearInterval(intervalo);
            }
            
            // Se o QR Code mudou, atualiza
            if (data.qrCode) {
                 // Opcional: atualizar o QR se ele mudar
            }

            tentativas++;
            if(tentativas > 60) clearInterval(intervalo); // Para depois de 2 min
        }, 2000);
    }
</script>

</body>
</html>