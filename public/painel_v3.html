<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zap FÃ¡cil - Upload</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .hidden { display: none; }
    </style>
</head>
<body class="py-4">

<div class="container">
    <h2 class="text-center mb-4 fw-bold text-primary">Zap FÃ¡cil 5.0 (Upload) ðŸ“‚</h2>

    <div class="row g-4">
        <div class="col-md-5">
            <div class="card p-3">
                <h5>ðŸ”Œ ConexÃ£o</h5>
                <input type="text" id="sessionId" class="form-control mb-2" value="CLIENTE_UPLOAD">
                <input type="text" id="webhookUrl" class="form-control mb-2" value="http://localhost:3000/webhook/test">
                <input type="text" id="phoneNumber" class="form-control mb-2" placeholder="5511999998888">
                <button onclick="iniciarSessao()" class="btn btn-primary w-100 mb-2">Conectar</button>
                <button onclick="desconectar()" class="btn btn-danger w-100 mb-2">Desconectar</button>
                <div class="text-center">
                    <span id="statusText" class="badge bg-secondary">OFF</span>
                    <div id="pairingArea" class="alert alert-warning mt-2 hidden">
                        CÃ“DIGO: <strong id="pairingCodeDisplay" style="font-size: 1.5em;"></strong>
                    </div>
                    <div id="qrcode" class="mt-2 d-flex justify-content-center"></div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card p-3">
                <h5>ðŸ“¤ Enviar Mensagem / Arquivo</h5>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <label>DestinatÃ¡rio</label>
                        <input type="text" id="targetNumber" class="form-control" placeholder="5511999998888">
                    </div>
                    <div class="col-6">
                        <label>Tipo</label>
                        <select id="msgType" class="form-select" onchange="mudarTipo()">
                            <option value="text">Texto</option>
                            <option value="image">Imagem</option>
                            <option value="document">Documento (PDF)</option>
                            <option value="video">VÃ­deo</option>
                        </select>
                    </div>
                </div>

                <div id="uploadArea" class="mb-3 p-3 bg-light border rounded hidden">
                    <label class="fw-bold mb-2">Selecione o Arquivo:</label>
                    <input type="file" id="fileInput" class="form-control">
                    <small class="text-muted">Suporta JPG, PNG, PDF, MP4</small>
                </div>

                <div class="mb-3">
                    <label id="msgLabel">Mensagem</label>
                    <textarea id="messageText" class="form-control" rows="2"></textarea>
                </div>

                <button onclick="enviar()" class="btn btn-success w-100">ENVIAR AGORA</button>
            </div>
        </div>
    </div>
</div>

<script>
    function mudarTipo() {
        const type = document.getElementById('msgType').value;
        if(type === 'text') {
            document.getElementById('uploadArea').classList.add('hidden');
            document.getElementById('msgLabel').innerText = 'Mensagem';
        } else {
            document.getElementById('uploadArea').classList.remove('hidden');
            document.getElementById('msgLabel').innerText = 'Legenda (Opcional)';
        }
    }

    async function enviar() {
        const type = document.getElementById('msgType').value;
        const sessionId = document.getElementById('sessionId').value;
        const number = document.getElementById('targetNumber').value;
        const text = document.getElementById('messageText').value;

        if(!sessionId || !number) return alert('Preencha sessÃ£o e nÃºmero!');

        // ENVIO DE TEXTO SIMPLES
        if (type === 'text') {
            const res = await fetch('/message/text', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sessionId, number, message: text })
            });
            const d = await res.json();
            alert(d.success ? 'Texto enviado!' : 'Erro: ' + JSON.stringify(d));
        } 
        // ENVIO DE ARQUIVO (MULTIPART)
        else {
            const fileInput = document.getElementById('fileInput');
            if(fileInput.files.length === 0) return alert('Selecione um arquivo!');

            const formData = new FormData();
            formData.append('sessionId', sessionId);
            formData.append('number', number);
            formData.append('type', type);
            formData.append('caption', text);
            formData.append('file', fileInput.files[0]); // Anexa o arquivo real

            try {
                const res = await fetch('/message/upload', {
                    method: 'POST',
                    body: formData // NÃ£o usa Content-Type JSON aqui
                });
                const d = await res.json();
                alert(d.success ? 'Arquivo enviado!' : 'Erro: ' + JSON.stringify(d));
            } catch(e) { alert('Erro upload: ' + e); }
        }
    }

    async function iniciarSessao() {
        const sessionId = document.getElementById('sessionId').value;
        const phoneNumber = document.getElementById('phoneNumber').value;
        const webhookUrl = document.getElementById('webhookUrl').value;
        
        document.getElementById('statusText').innerText = '...';
        
        await fetch('/session/start', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sessionId, phoneNumber, webhookUrl })
        });
        
        const i = setInterval(async () => {
            const res = await fetch(`/session/status?sessionId=${sessionId}`);
            const data = await res.json();
            if(data.status === 'connected') {
                document.getElementById('statusText').innerText = 'ON';
                document.getElementById('statusText').className = 'badge bg-success';
                document.getElementById('pairingArea').classList.add('hidden');
                document.getElementById('qrcode').innerHTML = '';
                clearInterval(i);
            } else if(data.pairingCode) {
                document.getElementById('pairingArea').classList.remove('hidden');
                document.getElementById('pairingCodeDisplay').innerText = data.pairingCode;
            } else if(data.qrCode) {
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {text: data.qrCode, width: 150, height: 150});
            }
        }, 3000);
    }

    async function desconectar() {
        const sessionId = document.getElementById('sessionId').value;
        await fetch('/session/logout', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sessionId })
        });
        alert('Desconectado');
        location.reload();
    }
</script>
</body>
</html>